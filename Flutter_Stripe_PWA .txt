# Flutter Stripe PWA Integration Guide

Based on analysis of the Flutter Stripe PWA tutorial by @shahwali_kh.

## Project Overview

A Flutter shopping cart application with Stripe payment integration that can be deployed as a PWA (Progressive Web App).

**Features:**
- Product catalog display
- Shopping cart functionality
- Stripe payment sheet integration
- Cross-platform support (iOS, Android, Web)

---

## 1. Project Structure

```
stripe_integration/
├── lib/
│   ├── main.dart
│   ├── models/
│   │   └── models.dart
│   ├── providers/
│   │   └── cart_provider.dart
│   ├── screens/
│   │   ├── home_screen.dart
│   │   └── cart_screen.dart
│   └── services/
│       └── payment_service.dart
├── pubspec.yaml
└── ...
```

---

## 2. Dependencies (pubspec.yaml)

```yaml
dependencies:
  flutter:
    sdk: flutter
  provider: ^6.0.0
  flutter_stripe: ^10.0.0
  http: ^1.1.0
```

---

## 3. Models (lib/models/models.dart)

```dart
class Product {
  final String id;
  final String name;
  required this.description,
  required this.price,
}

class CartItem {
  final Product product;
  int quantity;

  CartItem({required this.product, this.quantity = 1});

  double get total => product.price * quantity;
}
```

---

## 4. State Management (lib/providers/cart_provider.dart)

```dart
import 'package:flutter/material.dart';
import 'package:stripe_integration/models/models.dart';

class CartProvider extends ChangeNotifier {
  final List<CartItem> _items = [];

  List<CartItem> get items => _items;

  double get totalPrice => _items.fold(0, (sum, item) => sum + item.total);

  void addItem(Product product) {
    final existingIndex = _items.indexWhere((item) => item.product.id == product.id);
    if (existingIndex >= 0) {
      _items[existingIndex].quantity++;
    } else {
      _items.add(CartItem(product: product));
    }
    notifyListeners();
  }

  void removeItem(String productId) {
    _items.removeWhere((item) => item.product.id == productId);
    notifyListeners();
  }

  void clearCart() {
    _items.clear();
    notifyListeners();
  }
}
```

---

## 5. Stripe Configuration

### Step 1: Create Stripe Account
1. Go to [stripe.com](https://stripe.com) and sign in
2. Navigate to the Dashboard (Test Mode)
3. Get your API keys from Developers > API Keys

### Step 2: Configure main.dart

```dart
import 'package:flutter/material.dart';
import 'package:flutter_stripe/flutter_stripe.dart';
import 'package:provider/provider.dart';
import 'package:stripe_integration/providers/cart_provider.dart';
import 'package:stripe_integration/screens/home_screen.dart';

// Replace with your actual keys (use environment variables in production!)
String publishableKey = 'pk_test_51Kt6fhCN...'; // Your publishable key
String secretKey = 'sk_test_51Kt6fhCN...';       // Your secret key

void main() {
  WidgetsFlutterBinding.ensureInitialized();
  Stripe.publishableKey = publishableKey;
  Stripe.instance.applySettings();
  runApp(const ShoppingCartApp());
}

class ShoppingCartApp extends StatelessWidget {
  const ShoppingCartApp({super.key});

  @override
  Widget build(BuildContext context) {
    return ChangeNotifierProvider(
      create: (_) => CartProvider(),
      child: MaterialApp(
        title: 'Shopping App',
        theme: ThemeData(primarySwatch: Colors.blue),
        home: const HomeScreen(),
      ),
    );
  }
}
```

---

## 6. Payment Service (lib/services/payment_service.dart)

```dart
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter_stripe/flutter_stripe.dart';
import 'package:stripe_integration/main.dart';

class PaymentService {
  // Create Payment Intent on Stripe
  Future<String?> createPaymentIntent(int amount, String currency) async {
    try {
      final response = await http.post(
        Uri.parse('https://api.stripe.com/v1/payment_intents'),
        headers: {
          'Authorization': 'Bearer $secretKey',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: {
          'amount': amount.toString(),
          'currency': currency,
        },
      );

      if (response.statusCode == 200) {
        return jsonDecode(response.body)['client_secret'];
      } else {
        return null;
      }
    } catch (e) {
      print(e);
      return null;
    }
  }

  // Initialize and present Payment Sheet
  Future<void> makePayment(int amount, String currency, BuildContext context) async {
    try {
      final clientSecret = await createPaymentIntent(amount, currency);

      if (clientSecret == null) {
        throw Exception('Failed to create payment intent');
      }

      // Initialize Payment Sheet
      await Stripe.instance.initPaymentSheet(
        paymentSheetParameters: SetupPaymentSheetParameters(
          paymentIntentClientSecret: clientSecret,
          merchantDisplayName: 'Shopping App',
          style: ThemeMode.system,
        ),
      );

      // Present Payment Sheet
      await Stripe.instance.presentPaymentSheet();

      // Payment successful
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Payment successful!')),
      );
    } catch (e) {
      print(e);
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Payment failed: $e')),
      );
    }
  }
}
```

---

## 7. Payment Sheet Customization

The Stripe Payment Sheet appears as a **bottom sheet modal** - this is Stripe's pre-built UI, not a custom Flutter `showModalBottomSheet()`.

### What You CAN Customize

```dart
await Stripe.instance.initPaymentSheet(
  paymentSheetParameters: SetupPaymentSheetParameters(
    paymentIntentClientSecret: clientSecret,

    // Basic Customization
    merchantDisplayName: 'Your Store Name',
    style: ThemeMode.system, // .light, .dark, or .system

    // Appearance Customization
    appearance: PaymentSheetAppearance(
      colors: PaymentSheetAppearanceColors(
        primary: Colors.blue,
        background: Colors.white,
        componentBackground: Colors.grey[100],
        componentBorder: Colors.grey[300],
        componentDivider: Colors.grey[200],
        primaryText: Colors.black,
        secondaryText: Colors.grey[600],
        componentText: Colors.black,
        placeholderText: Colors.grey[400],
        icon: Colors.grey[600],
        error: Colors.red,
      ),
      shapes: PaymentSheetShape(
        borderRadius: 12,
        borderWidth: 1,
      ),
      primaryButton: PaymentSheetPrimaryButtonAppearance(
        colors: PaymentSheetPrimaryButtonTheme(
          light: PaymentSheetPrimaryButtonThemeColors(
            background: Colors.blue,
            text: Colors.white,
            border: Colors.blue,
          ),
        ),
        shapes: PaymentSheetPrimaryButtonShape(
          borderRadius: 8,
        ),
      ),
    ),

    // Billing Details Collection
    billingDetailsCollectionConfiguration: BillingDetailsCollectionConfiguration(
      name: CollectionMode.always,
      email: CollectionMode.always,
      phone: CollectionMode.automatic,
      address: AddressCollectionMode.full,
    ),

    // Customer Info (for returning customers)
    customerId: 'cus_xxx',
    customerEphemeralKeySecret: 'ek_xxx',

    // Apple/Google Pay
    applePay: PaymentSheetApplePay(
      merchantCountryCode: 'US',
    ),
    googlePay: PaymentSheetGooglePay(
      merchantCountryCode: 'US',
      testEnv: true,
    ),
  ),
);
```

### What You CANNOT Customize

| Limitation | Explanation |
|------------|-------------|
| **Layout Structure** | Cannot change the overall layout/arrangement |
| **Card Input Fields** | Cannot modify how card number, expiry, CVC appear |
| **Animation** | Cannot change how the sheet slides up |
| **Field Order** | Cannot reorder payment method fields |
| **Custom Widgets** | Cannot add your own Flutter widgets inside |
| **Full Branding** | Limited to colors/shapes, not full theming |

### Alternative: Full Custom UI

If you need complete control, use `CardField` widget instead:

```dart
// Custom card input (more work, full control)
CardField(
  onCardChanged: (card) {
    // Handle card input
  },
  decoration: InputDecoration(
    border: OutlineInputBorder(),
    labelText: 'Card Details',
  ),
)
```

**Trade-off:**
- `PaymentSheet` = Easy, secure, limited customization
- `CardField` = More work, full control, you handle UI

---

## 8. Home Screen (lib/screens/home_screen.dart)

```dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:stripe_integration/models/models.dart';
import 'package:stripe_integration/providers/cart_provider.dart';
import 'package:stripe_integration/screens/cart_screen.dart';

class HomeScreen extends StatelessWidget {
  const HomeScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final cart = context.watch<CartProvider>();
    final products = cart.products;

    return Scaffold(
      appBar: AppBar(
        title: const Text('Shop'),
        actions: [
          IconButton(
            icon: const Icon(Icons.shopping_cart),
            onPressed: () => Navigator.push(
              context,
              MaterialPageRoute(builder: (_) => const CartScreen()),
            ),
          ),
        ],
      ),
      body: GridView.builder(
        padding: const EdgeInsets.all(16),
        gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: 2,
          childAspectRatio: 0.75,
          crossAxisSpacing: 16,
          mainAxisSpacing: 16,
        ),
        itemCount: products.length,
        itemBuilder: (context, index) {
          final product = products[index];
          return ProductCard(product: product);
        },
      ),
    );
  }
}

class ProductCard extends StatelessWidget {
  final Product product;

  const ProductCard({super.key, required this.product});

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            height: 80,
            width: 80,
            color: Colors.grey[200],
            child: Center(
              child: Text(
                product.name[0],
                style: const TextStyle(fontSize: 32, fontWeight: FontWeight.bold),
              ),
            ),
          ),
          const SizedBox(height: 8),
          Text(product.name, style: const TextStyle(fontWeight: FontWeight.bold)),
          Text('\$${product.price.toStringAsFixed(2)}'),
          TextButton(
            onPressed: () {
              context.read<CartProvider>().addItem(product);
            },
            child: const Text('+ Add'),
          ),
        ],
      ),
    );
  }
}
```

---

## 9. Cart Screen (lib/screens/cart_screen.dart)

```dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:stripe_integration/providers/cart_provider.dart';
import 'package:stripe_integration/services/payment_service.dart';

class CartScreen extends StatelessWidget {
  const CartScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final cart = context.watch<CartProvider>();
    final items = cart.items;

    return Scaffold(
      appBar: AppBar(title: const Text('Cart')),
      body: Column(
        children: [
          Expanded(
            child: ListView.builder(
              itemCount: items.length,
              itemBuilder: (context, index) {
                final item = items[index];
                return ListTile(
                  title: Text(item.product.name),
                  subtitle: Text('\$${item.product.price.toStringAsFixed(2)}'),
                  trailing: Text('x${item.quantity}'),
                );
              },
            ),
          ),
          Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Text('Total:', style: TextStyle(fontSize: 18)),
                    Text(
                      '\$${cart.totalPrice.toStringAsFixed(2)}',
                      style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton.icon(
                    onPressed: items.isEmpty ? null : () async {
                      try {
                        // Convert to cents for Stripe
                        final amountInCents = (cart.totalPrice * 100).toInt();
                        await PaymentService().makePayment(
                          amountInCents,
                          'USD',
                          context,
                        );
                        // Clear cart after successful payment
                        cart.clearCart();
                      } catch (e) {
                        print(e);
                      }
                    },
                    icon: const Icon(Icons.payment),
                    label: const Text('Checkout'),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
```

---

## 10. Sample Products Data

Add sample products to your CartProvider:

```dart
// In cart_provider.dart
final List<Product> products = [
  Product(id: '1', name: 'Coffee Beans', description: 'Premium coffee', price: 12.99),
  Product(id: '2', name: 'Headphones', description: 'Wireless headphones', price: 59.99),
  Product(id: '3', name: 'Sneakers', description: 'Running shoes', price: 79.50),
  Product(id: '4', name: 'Backpack', description: 'Travel backpack', price: 42.00),
  Product(id: '5', name: 'Watch', description: 'Smart watch', price: 99.00),
  Product(id: '6', name: 'Sunglasses', description: 'UV protection', price: 24.99),
];
```

---

## 11. PWA Configuration (Web Deployment)

For PWA support, ensure your `web/manifest.json` is configured:

```json
{
  "name": "Shopping App",
  "short_name": "Shop",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#2196F3",
  "icons": [
    {
      "src": "icons/Icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "icons/Icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

---

## 12. Testing

### Test Mode
- Use Stripe test keys (pk_test_... and sk_test_...)
- Test card number: `4242 4242 4242 4242`
- Any future expiry date
- Any 3-digit CVC

### Run the App
```bash
# iOS Simulator
flutter run -d ios

# Android Emulator
flutter run -d android

# Web (PWA)
flutter run -d chrome
```

---

## 13. Important Security Notes

1. **Never expose secret keys in client-side code** - In production, create a backend server to handle payment intent creation
2. **Use environment variables** for API keys
3. **Implement proper error handling** for payment failures
4. **Validate amounts server-side** before creating payment intents

---

## 14. Resources

- [Flutter Stripe Package](https://pub.dev/packages/flutter_stripe)
- [Stripe API Documentation](https://stripe.com/docs/api)
- [Stripe Dashboard](https://dashboard.stripe.com)

---


